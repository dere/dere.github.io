<!DOCTYPE html>
<html>
<head>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>A Beginner's Guide to x86 Assembly, Part 2 of 2 &#8211; /dev/zero</title>
    <link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com">
    <link rel="dns-prefetch" href="//cdn.mathjax.org">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Derek Maciel's site and blog">
    <meta name="robots" content="all">
    <meta name="author" content="Derek Maciel">
    
    <meta name="keywords" content="">
    <link rel="canonical" href="http://localhost:4000/2017-02-13/beginners-assembly-part2/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for /dev/zero" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?201801202041" type="text/css">

    <!-- Fonts -->
    
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
    

    <!-- MathJax -->
    

    <!-- Verifications -->
    
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="A Beginner's Guide to x86 Assembly, Part 2 of 2">
    <meta property="og:description" content="In the final part of this series we will implement the calculator from the ground up.">
    <meta property="og:url" content="http://localhost:4000/2017-02-13/beginners-assembly-part2/">
    <meta property="og:site_name" content="/dev/zero">
    

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
    <meta name="twitter:title" content="A Beginner's Guide to x86 Assembly, Part 2 of 2" />
    <meta name="twitter:description" content="Derek Maciel's site and blog" />
    <meta name="twitter:url" content="http://localhost:4000/2017-02-13/beginners-assembly-part2/" />
    

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">

    
    <script type="text/javascript">
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
       ga('create', 'UA-41086430-1', 'auto');
       ga('send', 'pageview');
    </script>
    
</head>

<body class="site">
  
	

  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://localhost:4000" class="site-title">/dev/zero</a>
      <nav class="site-nav">
        
    <a href="http://localhost:4000/about/">About</a>

    <a href="http://localhost:4000/derek-maciel-resume.pdf">Resume</a>

    <a href="http://localhost:4000/email/">Email me</a>


      </nav>
      <div class="clearfix"></div>
      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>A Beginner's Guide to x86 Assembly, Part 2 of 2</h1>
  <span class="post-meta">Feb 13, 2017</span><br>
  
  <span class="post-meta small">
  
    13 minute read
  
  </span>
</div>

<article class="post-content">
  <p>In the <a href="/2017-02-12/beginners-assembly-part1/">previous part of this series</a> the main topics of x86 assembly programming such as the call stack x86 calling convention were introduced. In this final part we will apply that knowledge to write our RPN calculator.</p>

<p>The complete code of our calculator can be found <a href="https://gist.github.com/dere/9dff75a67710207e16cd6a8531393ccf">here</a>. It is heavily commented and may serve as a sufficient learning resource for those of you with some knowledge of assembly already. Now, lets get started.</p>

<p>For those of you unfamiliar with Reverse Polish notation (sometimes called postfix notation), expressions are evaluated using a stack. Therefore, we’ll need to create a stack to use as well as some <code class="highlighter-rouge">_pop</code> and <code class="highlighter-rouge">_push</code> functions to manipulate that stack. We’ll also need a function called <code class="highlighter-rouge">_print_answer</code> which will print the string-representation of the numeric result at the end of our calculation.</p>

<h2 id="creating-the-stack">Creating the stack</h2>

<p>First we’ll define a space in memory we will use for our stack as well as our global <code class="highlighter-rouge">stack_size</code> variable. We will wish to modify these variables so they will not go in the <code class="highlighter-rouge">.rodata</code> section, but instead, <code class="highlighter-rouge">.data</code>:</p>

<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="kr">section</span> <span class="p">.</span><span class="n">data</span>
    <span class="n">stack_size</span><span class="o">:</span> <span class="kt">dd</span> <span class="mi">0</span>        <span class="c">; create a dword (4-byte) variable set to zero</span>
    <span class="n">stack</span><span class="o">:</span> <span class="n">times</span> <span class="mi">256</span> <span class="kt">dd</span> <span class="mi">0</span>   <span class="c">; fill the stack with 256 dword zeroes </span>
</code></pre>
</div>

<p>Then we can implement the functions <code class="highlighter-rouge">_push</code> and <code class="highlighter-rouge">_pop</code>:</p>

<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="n">_push</span><span class="o">:</span>
    <span class="k">enter</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="c">; Save the callee-saved registers that I'll be using</span>
    <span class="k">push</span> <span class="n">eax</span>
    <span class="k">push</span> <span class="n">edx</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">stack_size</span><span class="err">]</span>
    <span class="k">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span>
    <span class="k">mov</span> <span class="err">[</span><span class="n">stack</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">eax</span><span class="err">]</span><span class="p">,</span> <span class="n">edx</span>    <span class="c">; Insert the arg into the stack. We scale</span>
                                <span class="c">; by 4 because each dword is 4 bytes each</span>
    <span class="k">inc</span> <span class="n">dword</span> <span class="err">[</span><span class="n">stack_size</span><span class="err">]</span>      <span class="c">; Add 1 to stack_size</span>
    <span class="c">; Restore the callee-saved registers we used</span>
    <span class="k">pop</span> <span class="n">edx</span>
    <span class="k">pop</span> <span class="n">eax</span>
    <span class="k">leave</span>
    <span class="k">ret</span>

<span class="n">_pop</span><span class="o">:</span>
    <span class="k">enter</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="c">; Save the callee-saved registers</span>
    <span class="k">dec</span> <span class="n">dword</span> <span class="err">[</span><span class="n">stack_size</span><span class="err">]</span>      <span class="c">; Subtract 1 from stack_size first</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">stack_size</span><span class="err">]</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">stack</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">eax</span><span class="err">]</span>    <span class="c">; Set the number at the top of the stack to eax</span>
    <span class="c">; Here I'd restore the callee-saved registers, but I didn't save any</span>
    <span class="k">leave</span>
    <span class="k">ret</span>
</code></pre>
</div>

<h2 id="printing-numbers">Printing numbers</h2>

<p><code class="highlighter-rouge">_print_answer</code> is a lot more complicated because we will have to convert numbers to strings, and that process requires using a few other functions. We’ll need a <code class="highlighter-rouge">_putc</code> function which will print a single character, a <code class="highlighter-rouge">mod</code> function to calculate the modulus of two arguments, and <code class="highlighter-rouge">_pow_10</code> to calculate a power of 10. You’ll see why we need them later. These are pretty simple so lets do that now:</p>

<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="n">_pow_10</span><span class="o">:</span>
    <span class="k">enter</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span>    <span class="c">; set ecx (caller-saved) to function arg</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">1</span>          <span class="c">; first power of 10 (10**0 = 1)</span>
<span class="n">_pow_10_loop_start</span><span class="o">:</span>     <span class="c">; multiply eax by 10 until ecx is 0</span>
    <span class="k">cmp</span> <span class="n">ecx</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">je</span> <span class="n">_pow_10_loop_end</span>
    <span class="k">imul</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">10</span>
    <span class="k">sub</span> <span class="n">ecx</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">jmp</span> <span class="n">_pow_10_loop_start</span>
<span class="n">_pow_10_loop_end</span><span class="o">:</span>
    <span class="k">leave</span>
    <span class="k">ret</span>

<span class="n">_mod</span><span class="o">:</span>
    <span class="k">enter</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">push</span> <span class="n">ebx</span>
    <span class="k">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="mi">0</span>          <span class="c">; explained below</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span>
    <span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="mi">12</span><span class="err">]</span>
    <span class="k">idiv</span> <span class="n">ebx</span>            <span class="c">; divides the 64-bit integer [edx:eax] by ebx. We only want to</span>
                        <span class="c">; divide the 32-bit integer eax, so we set edx to zero. The</span>
                        <span class="c">; result of this division is stored in eax, and the remainder</span>
                        <span class="c">; is stored in edx. As always, you can find more about this</span>
                        <span class="c">; instruction in the resources below.</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">edx</span>        <span class="c">; return the modulus</span>
    <span class="k">pop</span> <span class="n">ebx</span>
    <span class="k">leave</span>
    <span class="k">ret</span>

<span class="n">_putc</span><span class="o">:</span>
    <span class="k">enter</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0x04</span>       <span class="c">; write()</span>
    <span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="mi">1</span>          <span class="c">; standard out</span>
    <span class="k">lea</span> <span class="n">ecx</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span>    <span class="c">; the input character</span>
    <span class="k">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="mi">1</span>          <span class="c">; print only 1 character</span>
    <span class="k">int</span> <span class="mh">0x80</span>
    <span class="k">leave</span>
    <span class="k">ret</span>
</code></pre>
</div>

<p>Now, how do we print the digits of a number? First, note that we can get the last digit of a number by finding the modulus of <code class="highlighter-rouge">10</code> (for example, <code class="highlighter-rouge">123 % 10 = 3</code>), and we can get the next digit by finding the modulus of <code class="highlighter-rouge">100</code> and dividing that result by <code class="highlighter-rouge">10</code> (for example, <code class="highlighter-rouge">(123 % 100)/10 = 2</code>). In general, we can find a specific digit (going from right to left) of a number by finding <code class="highlighter-rouge">(number % 10**n) / 10**(n-1)</code>, where the ones digit would be <code class="highlighter-rouge">n = 1</code>, the tens digit <code class="highlighter-rouge">n = 2</code> and so on.</p>

<p>Using that knowledge we can find all the digits of a number by starting at <code class="highlighter-rouge">n = 1</code> and iterating to <code class="highlighter-rouge">n = 10</code> (the most digits a signed 4-byte integer can have). However, it would be a lot easier if we could go from left to right – that would allow us to print each character as we find it and prevent trailing zeroes to the left of the number – so we’ll instead iterate from <code class="highlighter-rouge">n = 10</code> to <code class="highlighter-rouge">n = 1</code>.</p>

<p>It should look something like the following C code:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#define MAX_DIGITS 10
</span><span class="kt">void</span> <span class="nf">print_answer</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// if the number is negative
</span>        <span class="n">putc</span><span class="p">(</span><span class="sc">'-'</span><span class="p">);</span> <span class="c1">// print a negative sign
</span>        <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span><span class="p">;</span> <span class="c1">// convert the number to positive
</span>    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">MAX_DIGITS</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">digit</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">%</span> <span class="n">pow_10</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">/</span> <span class="n">pow_10</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">digit</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">started</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span> <span class="c1">// don't print trailing zeroes
</span>        <span class="n">started</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">putc</span><span class="p">(</span><span class="n">digit</span> <span class="o">+</span> <span class="sc">'0'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now you’ll see why we need those three functions we implemented before. Now lets implement this in assembly:</p>

<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="cp">%define</span> <span class="n">MAX_DIGITS</span> <span class="mi">10</span>

<span class="n">_print_answer</span><span class="o">:</span>
    <span class="k">enter</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>              <span class="c">; we'll use 1 byte for "started" variable in C</span>
    <span class="k">push</span> <span class="n">ebx</span>
    <span class="k">push</span> <span class="n">edi</span>
    <span class="k">push</span> <span class="n">esi</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span>        <span class="c">; our "a" argument</span>
    <span class="k">cmp</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span>              <span class="c">; if the number is not negative, skip this if-statement</span>
    <span class="k">jge</span> <span class="n">_print_answer_negate_end</span>
    <span class="c">; call putc for '-'</span>
    <span class="k">push</span> <span class="n">eax</span>
    <span class="k">push</span> <span class="mh">0x2d</span>               <span class="c">; '-' character</span>
    <span class="k">call</span> <span class="n">_putc</span>
    <span class="k">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">4</span>
    <span class="k">pop</span> <span class="n">eax</span>
    <span class="k">neg</span> <span class="n">eax</span>                 <span class="c">; convert a to positive</span>
<span class="n">_print_answer_negate_end</span><span class="o">:</span>
    <span class="k">mov</span> <span class="n">byte</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">4</span><span class="err">]</span><span class="p">,</span> <span class="mi">0</span>     <span class="c">; started = 0</span>
    <span class="k">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">MAX_DIGITS</span>     <span class="c">; our i variable</span>
<span class="n">_print_answer_loop_start</span><span class="o">:</span>
    <span class="k">cmp</span> <span class="n">ecx</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">je</span> <span class="n">_print_answer_loop_end</span>
    <span class="c">; call pow_10 for ecx. We'll be trying to get ebx to be out "digit" variable in C.</span>
    <span class="c">; For now we'll get edx = pow_10(i-1) and ebx = pow_10(i)</span>
    <span class="k">push</span> <span class="n">eax</span>
    <span class="k">push</span> <span class="n">ecx</span>
    <span class="k">dec</span> <span class="n">ecx</span>             <span class="c">; i-1</span>
    <span class="k">push</span> <span class="n">ecx</span>            <span class="c">; arg1 for _pow_10</span>
    <span class="k">call</span> <span class="n">_pow_10</span>
    <span class="k">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="n">eax</span>        <span class="c">; edx = pow_10(i-1)</span>
    <span class="k">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">4</span>
    <span class="k">pop</span> <span class="n">ecx</span>             <span class="c">; restore ecx to i</span>
    <span class="k">pop</span> <span class="n">eax</span>
    <span class="c">; end pow_10 call</span>
    <span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">edx</span>        <span class="c">; digit = ebx = pow_10(i-1)</span>
    <span class="k">imul</span> <span class="n">ebx</span><span class="p">,</span> <span class="mi">10</span>        <span class="c">; digit = ebx = pow_10(i)</span>
    <span class="c">; call _mod for (a % pow_10(i)), which is (eax mod ebx)</span>
    <span class="k">push</span> <span class="n">eax</span>
    <span class="k">push</span> <span class="n">ecx</span>
    <span class="k">push</span> <span class="n">edx</span>
    <span class="k">push</span> <span class="n">ebx</span>            <span class="c">; arg2, ebx = digit = pow_10(i)</span>
    <span class="k">push</span> <span class="n">eax</span>            <span class="c">; arg1, eax = a</span>
    <span class="k">call</span> <span class="n">_mod</span>
    <span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">eax</span>        <span class="c">; digit = ebx = a % pow_10(i+1), almost there</span>
    <span class="k">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">8</span>
    <span class="k">pop</span> <span class="n">edx</span>
    <span class="k">pop</span> <span class="n">ecx</span>
    <span class="k">pop</span> <span class="n">eax</span>
    <span class="c">; end mod call</span>
    <span class="c">; divide ebx ("digit" var) by pow_10(i) (edx).  We'll need to save a few registers</span>
    <span class="c">; since idiv requires both edx and eax for the dividend. Since edx is our divisor,</span>
    <span class="c">; we'll need to move it to some other register</span>
    <span class="k">push</span> <span class="n">esi</span>
    <span class="k">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="n">edx</span>
    <span class="k">push</span> <span class="n">eax</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ebx</span>
    <span class="k">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">idiv</span> <span class="n">esi</span>            <span class="c">; eax holds the result (the digit)</span>
    <span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">eax</span>        <span class="c">; ebx = (a % pow_10(i)) / pow_10(i-1), the "digit" variable in C</span>
    <span class="k">pop</span> <span class="n">eax</span>
    <span class="k">pop</span> <span class="n">esi</span>
    <span class="c">; end division</span>
    <span class="k">cmp</span> <span class="n">ebx</span><span class="p">,</span> <span class="mi">0</span>                        <span class="c">; if digit == 0</span>
    <span class="k">jne</span> <span class="n">_print_answer_trailing_zeroes_check_end</span>
    <span class="k">cmp</span> <span class="n">byte</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">4</span><span class="err">]</span><span class="p">,</span> <span class="mi">0</span>               <span class="c">; if started == 0</span>
    <span class="k">jne</span> <span class="n">_print_answer_trailing_zeroes_check_end</span>
    <span class="k">jmp</span> <span class="n">_print_answer_loop_continue</span>   <span class="c">; continue</span>
<span class="n">_print_answer_trailing_zeroes_check_end</span><span class="o">:</span>
    <span class="k">mov</span> <span class="n">byte</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">4</span><span class="err">]</span><span class="p">,</span> <span class="mi">1</span>     <span class="c">; started = 1</span>
    <span class="k">add</span> <span class="n">ebx</span><span class="p">,</span> <span class="mh">0x30</span>           <span class="c">; digit + '0'</span>
    <span class="c">; call putc</span>
    <span class="k">push</span> <span class="n">eax</span>
    <span class="k">push</span> <span class="n">ecx</span>
    <span class="k">push</span> <span class="n">edx</span>
    <span class="k">push</span> <span class="n">ebx</span>
    <span class="k">call</span> <span class="n">_putc</span>
    <span class="k">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">4</span>
    <span class="k">pop</span> <span class="n">edx</span>
    <span class="k">pop</span> <span class="n">ecx</span>
    <span class="k">pop</span> <span class="n">eax</span>
    <span class="c">; end call putc</span>
<span class="n">_print_answer_loop_continue</span><span class="o">:</span>
    <span class="k">sub</span> <span class="n">ecx</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">jmp</span> <span class="n">_print_answer_loop_start</span>
<span class="n">_print_answer_loop_end</span><span class="o">:</span>
    <span class="k">pop</span> <span class="n">esi</span>
    <span class="k">pop</span> <span class="n">edi</span>
    <span class="k">pop</span> <span class="n">ebx</span>
    <span class="k">leave</span>
    <span class="k">ret</span>
</code></pre>
</div>

<p>That was a tough one! Hopefully tracing through the comments help. If now all you’re thinking is “Man I sure wish I could have used <code class="highlighter-rouge">printf("%d")</code>, then you will enjoy the end of this article when we replace this function with just that!</p>

<p>Now that we have all the functions necessary, we can implement the main logic in <code class="highlighter-rouge">_start</code> and we’ll be done!</p>

<h2 id="evaluating-reverse-polish-notation">Evaluating Reverse Polish notation</h2>

<p>As we’ve said before, Reverse Polish notation is evaluated using a stack. When a number is read it is pushed onto the stack, and when an operator is read it is applied to the two operands at the top of the stack.</p>

<p>For example, if we wish to evaluate <code class="highlighter-rouge">84/3+6*</code><sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>, that process would look like:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Step</th>
      <th style="text-align: center">Character checked</th>
      <th style="text-align: center">Stack before</th>
      <th style="text-align: center">Stack after</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: center"><code class="highlighter-rouge">8</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">[]</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">[8]</code></td>
    </tr>
    <tr>
      <td style="text-align: center">2</td>
      <td style="text-align: center"><code class="highlighter-rouge">4</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">[8]</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">[8, 4]</code></td>
    </tr>
    <tr>
      <td style="text-align: center">3</td>
      <td style="text-align: center"><code class="highlighter-rouge">/</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">[8, 4]</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">[2]</code></td>
    </tr>
    <tr>
      <td style="text-align: center">4</td>
      <td style="text-align: center"><code class="highlighter-rouge">3</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">[2]</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">[2, 3]</code></td>
    </tr>
    <tr>
      <td style="text-align: center">5</td>
      <td style="text-align: center"><code class="highlighter-rouge">+</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">[2, 3]</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">[5]</code></td>
    </tr>
    <tr>
      <td style="text-align: center">6</td>
      <td style="text-align: center"><code class="highlighter-rouge">6</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">[5]</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">[5, 6]</code></td>
    </tr>
    <tr>
      <td style="text-align: center">7</td>
      <td style="text-align: center"><code class="highlighter-rouge">*</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">[5, 6]</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">[30]</code></td>
    </tr>
  </tbody>
</table>

<p>If the input is a valid postfix expression, at the end there will only be one element on the stack, which will be the answer the expression evaluates to. So in this case, the expression evaluates to <code class="highlighter-rouge">30</code>.</p>

<p>What we need to implement in assembly is something like the following C code:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">stack</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>         <span class="c1">// 256 is probably plenty big for our stack
</span><span class="kt">int</span> <span class="n">stack_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">input</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kt">size_t</span> <span class="n">input_length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">input_length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">input</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">'0'</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">'9'</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// if the character is a digit
</span>            <span class="n">push</span><span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="sc">'0'</span><span class="p">);</span> <span class="c1">// convert the character digit to an integer and push that
</span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
            <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'+'</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">push</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">push</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'*'</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">push</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'/'</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">push</span><span class="p">(</span><span class="n">a</span><span class="o">/</span><span class="n">b</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">error</span><span class="p">(</span><span class="s">"Invalid input</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">stack_size</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">error</span><span class="p">(</span><span class="s">"Invalid input</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="n">print_answer</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Since we now have all of the functions necessary to implement this, lets get started.</p>

<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="n">_start</span><span class="o">:</span>
    <span class="c">; you do not get the arguments of _start the same way you do in other functions.</span>
    <span class="c">; instead, esp points directly to argc (the number of arguments), and esp+4 points</span>
    <span class="c">; to argv. Therefore, esp+4 points to the name of your program, esp+8 points to</span>
    <span class="c">; the first argument, etc</span>
    <span class="k">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span>         <span class="c">; esi = "input" = argv[0]</span>
    <span class="c">; call _strlen to find the length of the input</span>
    <span class="k">push</span> <span class="n">esi</span>
    <span class="k">call</span> <span class="n">_strlen</span>
    <span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">eax</span>             <span class="c">; ebx = input_length</span>
    <span class="k">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">4</span>
    <span class="c">; end _strlen call</span>
    <span class="k">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="mi">0</span>               <span class="c">; ecx = "i"</span>
<span class="n">_main_loop_start</span><span class="o">:</span>
    <span class="k">cmp</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ebx</span>             <span class="c">; if (i &gt;= input_length)</span>
    <span class="k">jge</span> <span class="n">_main_loop_end</span>
    <span class="k">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">mov</span> <span class="n">dl</span><span class="p">,</span> <span class="err">[</span><span class="n">esi</span> <span class="o">+</span> <span class="n">ecx</span><span class="err">]</span>      <span class="c">; load only a byte from memory into the lower byte of</span>
                             <span class="c">; edx. We set the rest of edx to zero.</span>
                             <span class="c">; edx = c variable = input[i]</span>
    <span class="k">cmp</span> <span class="n">edx</span><span class="p">,</span> <span class="sc">'0'</span>
    <span class="k">jl</span> <span class="n">_check_operator</span>
    <span class="k">cmp</span> <span class="n">edx</span><span class="p">,</span> <span class="sc">'9'</span>
    <span class="k">jg</span> <span class="n">_print_error</span>
    <span class="k">sub</span> <span class="n">edx</span><span class="p">,</span> <span class="sc">'0'</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">edx</span>             <span class="c">; eax = c variable - '0' (the numeric digit, not char)</span>
    <span class="k">jmp</span> <span class="n">_push_eax_and_continue</span>
<span class="n">_check_operator</span><span class="o">:</span>
    <span class="c">; call _pop twice to pop b into edi and a into eax</span>
    <span class="k">push</span> <span class="n">ecx</span>
    <span class="k">push</span> <span class="n">ebx</span>
    <span class="k">call</span> <span class="n">_pop</span>
    <span class="k">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="n">eax</span>             <span class="c">; edi = b</span>
    <span class="k">call</span> <span class="n">_pop</span>                <span class="c">; eax = a</span>
    <span class="k">pop</span> <span class="n">ebx</span>
    <span class="k">pop</span> <span class="n">ecx</span>
    <span class="c">; end call _pop</span>
    <span class="k">cmp</span> <span class="n">edx</span><span class="p">,</span> <span class="sc">'+'</span>
    <span class="k">jne</span> <span class="n">_subtract</span>
    <span class="k">add</span> <span class="n">eax</span><span class="p">,</span> <span class="n">edi</span>                 <span class="c">; eax = a+b</span>
    <span class="k">jmp</span> <span class="n">_push_eax_and_continue</span>
<span class="n">_subtract</span><span class="o">:</span>
    <span class="k">cmp</span> <span class="n">edx</span><span class="p">,</span> <span class="sc">'-'</span>
    <span class="k">jne</span> <span class="n">_multiply</span>
    <span class="k">sub</span> <span class="n">eax</span><span class="p">,</span> <span class="n">edi</span>                 <span class="c">; eax = a-b</span>
    <span class="k">jmp</span> <span class="n">_push_eax_and_continue</span>
<span class="n">_multiply</span><span class="o">:</span>
    <span class="k">cmp</span> <span class="n">edx</span><span class="p">,</span> <span class="sc">'*'</span>
    <span class="k">jne</span> <span class="n">_divide</span>
    <span class="k">imul</span> <span class="n">eax</span><span class="p">,</span> <span class="n">edi</span>                <span class="c">; eax = a*b</span>
    <span class="k">jmp</span> <span class="n">_push_eax_and_continue</span>
<span class="n">_divide</span><span class="o">:</span>
    <span class="k">cmp</span> <span class="n">edx</span><span class="p">,</span> <span class="sc">'/'</span>
    <span class="k">jne</span> <span class="n">_print_error</span>
    <span class="k">push</span> <span class="n">edx</span>                     <span class="c">; save edx since we'll need to set it to 0 for idiv</span>
    <span class="k">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">idiv</span> <span class="n">edi</span>                     <span class="c">; eax = a/b</span>
    <span class="k">pop</span> <span class="n">edx</span>
    <span class="c">; now we push eax and continue</span>
<span class="n">_push_eax_and_continue</span><span class="o">:</span>
    <span class="c">; call _push</span>
    <span class="k">push</span> <span class="n">eax</span>
    <span class="k">push</span> <span class="n">ecx</span>
    <span class="k">push</span> <span class="n">edx</span>
    <span class="k">push</span> <span class="n">eax</span>          <span class="c">; arg1</span>
    <span class="k">call</span> <span class="n">_push</span>
    <span class="k">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">4</span>
    <span class="k">pop</span> <span class="n">edx</span>
    <span class="k">pop</span> <span class="n">ecx</span>
    <span class="k">pop</span> <span class="n">eax</span>
    <span class="c">; end call _push</span>
    <span class="k">inc</span> <span class="n">ecx</span>
    <span class="k">jmp</span> <span class="n">_main_loop_start</span>
<span class="n">_main_loop_end</span><span class="o">:</span>
    <span class="k">cmp</span> <span class="n">byte</span> <span class="err">[</span><span class="n">stack_size</span><span class="err">]</span><span class="p">,</span> <span class="mi">1</span>      <span class="c">; if (stack_size != 1) print error</span>
    <span class="k">jne</span> <span class="n">_print_error</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[stack]</span>
    <span class="k">push</span> <span class="n">eax</span>
    <span class="k">call</span> <span class="n">_print_answer</span>
    <span class="c">; print a final newline</span>
    <span class="k">push</span> <span class="mh">0xA</span>
    <span class="k">call</span> <span class="n">_putc</span>
    <span class="c">; exit successfully</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0x01</span>           <span class="c">; 0x01 = exit()</span>
    <span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="mi">0</span>              <span class="c">; 0 = no errors</span>
    <span class="k">int</span> <span class="mh">0x80</span>                <span class="c">; execution will end here</span>
<span class="n">_print_error</span><span class="o">:</span>
    <span class="k">push</span> <span class="n">error_msg</span>
    <span class="k">call</span> <span class="n">_print_msg</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0x01</span>
    <span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">int</span> <span class="mh">0x80</span>
</code></pre>
</div>

<p>You’ll also need to add a <code class="highlighter-rouge">error_msg</code> string to your <code class="highlighter-rouge">.rodata</code> section, something like:</p>

<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="kr">section</span> <span class="p">.</span><span class="n">rodata</span>
    <span class="c">; Declare some bytes at a symbol called error_msg. NASM's db pseudo-instruction</span>
    <span class="c">; allows either a single byte value, a constant string, or a combination of the two</span>
    <span class="c">; as seen here. 0xA = new line, and 0x0 = string-terminating null</span>
    <span class="n">error_msg</span><span class="o">:</span> <span class="kt">db</span> <span class="s">"Invalid input"</span><span class="p">,</span> <span class="mh">0xA</span><span class="p">,</span> <span class="mh">0x0</span>
</code></pre>
</div>

<p>And we’re done! Time to impress all your friends, if you have any. Hopefully at this point you have a new appreciation for higher-level languages, especially when you realize that many older programs were written entirely or almost entirely in assembly, such as the original RollerCoaster Tycoon!</p>

<p>The complete code can be found <a href="https://gist.github.com/dere/9dff75a67710207e16cd6a8531393ccf">here</a>. Thanks for reading! Continue on for some extra credit, if you dare.</p>

<h2 id="next-steps">Next steps</h2>

<p>Here are some features you can add for additional practice:</p>

<ol>
  <li>Throw an error if the user does not supply 1 argument to the program instead of just segfaulting</li>
  <li>Add support for optional spaces between operands and operators in the input</li>
  <li>Add support for multi-digit operands</li>
  <li>Allow negative numbers in the input</li>
  <li>Replace <code class="highlighter-rouge">_strlen</code> with the one in <a href="https://en.wikipedia.org/wiki/X86_assembly_language#.22Hello_world.21.22_program_for_Linux_in_NASM_style_assembly_using_the_C_standard_library">the C standard library</a> and <code class="highlighter-rouge">_print_answer</code> with a call to <code class="highlighter-rouge">printf</code>.</li>
</ol>

<h2 id="additional-reading">Additional reading</h2>

<ul>
  <li><a href="http://www.cs.virginia.edu/~evans/cs216/guides/x86.html">University of Virginia’s Guide to x86 Assembly</a> – Goes more into depth on many of the topics covered here, including more information on each of the most common x86 instructions. A great reference for the most common x86 instructions as well.</li>
  <li><a href="http://www.swansontec.com/sregisters.html">The Art of Picking Intel Registers</a> – While most of the x86 registers are general-purpose, many of the registers have a historical meaning. Following those conventions can improve code readability, and as an interesting side benefit, will even slightly optimize the size of your binaries.</li>
  <li><a href="http://www.posix.nl/linuxassembly/nasmdochtml/nasmdoca.html">NASM: Intel x86 Instruction Reference</a> - a full reference to all the obscure x86 instructions.</li>
</ul>
<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p><code class="highlighter-rouge">6384/+*</code> is another way of writing the same expression.&nbsp;<a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

</article>













      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>
      &copy; Derek Maciel. All rights reserved. Powered by <a href="https://pages.github.com">Github Pages</a> and <a href="https://cloudflare.com">Cloudflare</a>. Theme crafted with &lt;3 by <a href="http://johnotander.com">John Otander</a> (&lt;/&gt; available on <a href="https://github.com/johnotander/pixyll">GitHub</a>).
    </small>
  </div>
</footer>


</body>
</html>
